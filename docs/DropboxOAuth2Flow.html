<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: DropboxOAuth2Flow</title>

  <link rel="stylesheet" href="./rdoc.css" type="text/css" media="screen" />

  <script src="./js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="./build/dropbox-ruby-sdk-1_6_2/lib/dropbox_sdk_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="build/dropbox-ruby-sdk-1.6.2/lib/dropbox_sdk.rb">build/dropbox-ruby-sdk-1.6.2/lib/dropbox_sdk.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link">DropboxOAuth2FlowBase</p>
        
      </div>
      

      

      
      <!-- Namespace Contents -->
      <div id="namespace-list-section" class="section">
        <h3 class="section-header">Namespace</h3>
        <ul class="link-list">
          
          <li><span class="type">CLASS</span> <a href="DropboxOAuth2Flow/BadRequestError.html">DropboxOAuth2Flow::BadRequestError</a></li>
          
          <li><span class="type">CLASS</span> <a href="DropboxOAuth2Flow/BadStateError.html">DropboxOAuth2Flow::BadStateError</a></li>
          
          <li><span class="type">CLASS</span> <a href="DropboxOAuth2Flow/CsrfError.html">DropboxOAuth2Flow::CsrfError</a></li>
          
          <li><span class="type">CLASS</span> <a href="DropboxOAuth2Flow/NotApprovedError.html">DropboxOAuth2Flow::NotApprovedError</a></li>
          
          <li><span class="type">CLASS</span> <a href="DropboxOAuth2Flow/ProviderError.html">DropboxOAuth2Flow::ProviderError</a></li>
          
        </ul>
      </div>
      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-new">::new</a></li>
          
          <li><a href="#method-i-finish">#finish</a></li>
          
          <li><a href="#method-i-start">#start</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./DropboxOAuth2Flow.html">DropboxOAuth2Flow</a></li>
        
          <li><a href="./DropboxOAuth2Flow/BadRequestError.html">DropboxOAuth2Flow::BadRequestError</a></li>
        
          <li><a href="./DropboxOAuth2Flow/BadStateError.html">DropboxOAuth2Flow::BadStateError</a></li>
        
          <li><a href="./DropboxOAuth2Flow/CsrfError.html">DropboxOAuth2Flow::CsrfError</a></li>
        
          <li><a href="./DropboxOAuth2Flow/NotApprovedError.html">DropboxOAuth2Flow::NotApprovedError</a></li>
        
          <li><a href="./DropboxOAuth2Flow/ProviderError.html">DropboxOAuth2Flow::ProviderError</a></li>
        
          <li><a href="./DropboxClient.html">DropboxClient</a></li>
        
          <li><a href="./DropboxClient/ChunkedUploader.html">DropboxClient::ChunkedUploader</a></li>
        
          <li><a href="./DropboxAuthError.html">DropboxAuthError</a></li>
        
          <li><a href="./DropboxError.html">DropboxError</a></li>
        
          <li><a href="./DropboxNotModified.html">DropboxNotModified</a></li>
        
          <li><a href="./DropboxOAuth2FlowNoRedirect.html">DropboxOAuth2FlowNoRedirect</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">DropboxOAuth2Flow</h1>

    <div id="description" class="description">
      
<p>The standard OAuth 2 authorization helper.  Use this if you’re writing a
web app.</p>

    </div><!-- description -->

    
    
    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      

      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="new-method" class="method-detail ">
          <a name="method-c-new"></a>

          
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(consumer_key, consumer_secret, redirect_uri, session, csrf_token_session_key, locale=nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <ul><li>
<p>consumer_key: Your Dropbox API app’s “app key”</p>
</li><li>
<p>consumer_secret: Your Dropbox API app’s “app secret”</p>
</li><li>
<p>redirect_uri: The URI that the Dropbox server will redirect the user to
after the user finishes authorizing your app.  This URI  must be
HTTPs-based and pre-registered with the Dropbox servers, though localhost
URIs are allowed without pre-registration and can be either HTTP or HTTPS.</p>
</li><li>
<p>session: A hash that represents the current web app session (will be used
to save the CSRF token)</p>
</li><li>
<p>csrf_token_key: The key to use when storing the CSRF token in the session
(for example, :dropbox_auth_csrf_token)</p>
</li><li>
<p>locale: The locale of the user currently using your app (ex: “en” or
“en_US”).</p>
</li></ul>
            

            
            <div class="method-source-code" id="new-source">
<pre>
<span class="ruby-comment"># File build/dropbox-ruby-sdk-1.6.2/lib/dropbox_sdk.rb, line 483</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">consumer_key</span>, <span class="ruby-identifier">consumer_secret</span>, <span class="ruby-identifier">redirect_uri</span>, <span class="ruby-identifier">session</span>, <span class="ruby-identifier">csrf_token_session_key</span>, <span class="ruby-identifier">locale</span>=<span class="ruby-keyword">nil</span>)
    <span class="ruby-keyword">super</span>(<span class="ruby-identifier">consumer_key</span>, <span class="ruby-identifier">consumer_secret</span>, <span class="ruby-identifier">locale</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">redirect_uri</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;redirect_uri must be a String, got #{consumer_secret.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@redirect_uri</span> = <span class="ruby-identifier">redirect_uri</span>
    <span class="ruby-ivar">@session</span> = <span class="ruby-identifier">session</span>
    <span class="ruby-ivar">@csrf_token_session_key</span> = <span class="ruby-identifier">csrf_token_session_key</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- new-source -->
            
          </div>

          

          
        </div><!-- new-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="finish-method" class="method-detail ">
          <a name="method-i-finish"></a>

          
          <div class="method-heading">
            <span class="method-name">finish</span><span
              class="method-args">(query_params)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Call this after the user has visited the authorize URL (see: start()),
approved your app, and was redirected to your redirect URI.</p>
<ul><li>
<p>query_params: The query params on the GET request to your redirect URI.</p>
</li></ul>

<p>Returns a tuple of (access_token, user_id, url_state).  access_token can be
used to construct a <a href="DropboxClient.html">DropboxClient</a>. 
user_id is the Dropbox user ID of the user that jsut approved your app. 
url_state is the value you originally passed in to start().</p>

<p>Can throw <a
href="DropboxOAuth2Flow/BadRequestError.html">BadRequestError</a>, <a
href="DropboxOAuth2Flow/BadStateError.html">BadStateError</a>, <a
href="DropboxOAuth2Flow/CsrfError.html">CsrfError</a>, <a
href="DropboxOAuth2Flow/NotApprovedError.html">NotApprovedError</a>, <a
href="DropboxOAuth2Flow/ProviderError.html">ProviderError</a>, and the
standard <a href="DropboxError.html">DropboxError</a>.</p>
            

            
            <div class="method-source-code" id="finish-source">
<pre>
<span class="ruby-comment"># File build/dropbox-ruby-sdk-1.6.2/lib/dropbox_sdk.rb, line 533</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">finish</span>(<span class="ruby-identifier">query_params</span>)
    <span class="ruby-identifier">csrf_token_from_session</span> = <span class="ruby-ivar">@session</span>[<span class="ruby-ivar">@csrf_token_session_key</span>]

    <span class="ruby-comment"># Check well-formedness of request.</span>

    <span class="ruby-identifier">state</span> = <span class="ruby-identifier">query_params</span>[<span class="ruby-string">'state'</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadRequestError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Missing query parameter 'state'.&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">error</span> = <span class="ruby-identifier">query_params</span>[<span class="ruby-string">'error'</span>]
    <span class="ruby-identifier">error_description</span> = <span class="ruby-identifier">query_params</span>[<span class="ruby-string">'error_description'</span>]
    <span class="ruby-identifier">code</span> = <span class="ruby-identifier">query_params</span>[<span class="ruby-string">'code'</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">code</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadRequestError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Query parameters 'code' and 'error' are both set;&quot;</span> <span class="ruby-operator">+</span>
                                  <span class="ruby-string">&quot; only one must be set.&quot;</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">code</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadRequestError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Neither query parameter 'code' or 'error' is set.&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Check CSRF token</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">csrf_token_from_session</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadStateError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Missing CSRF token in session.&quot;</span>);
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">csrf_token_from_session</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;CSRF token unexpectedly short: #{csrf_token_from_session.inspect}&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">split_pos</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">index</span>(<span class="ruby-string">'|'</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">split_pos</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">given_csrf_token</span> = <span class="ruby-identifier">state</span>
        <span class="ruby-identifier">url_state</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">given_csrf_token</span>, <span class="ruby-identifier">url_state</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">'|'</span>, <span class="ruby-value">2</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-constant">Dropbox</span><span class="ruby-operator">::</span><span class="ruby-identifier">safe_string_equals</span>(<span class="ruby-identifier">csrf_token_from_session</span>, <span class="ruby-identifier">given_csrf_token</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">CsrfError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;Expected #{csrf_token_from_session.inspect}, &quot;</span> <span class="ruby-operator">+</span>
                                <span class="ruby-node">&quot;got #{given_csrf_token.inspect}.&quot;</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@csrf_token_session_key</span>)

    <span class="ruby-comment"># Check for error identifier</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">error</span> <span class="ruby-operator">==</span> <span class="ruby-string">'access_denied'</span>
            <span class="ruby-comment"># The user clicked &quot;Deny&quot;</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">error_description</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotApprovedError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;No additional description from Dropbox.&quot;</span>)
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotApprovedError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;Additional description from Dropbox: #{error_description}&quot;</span>)
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-comment"># All other errors.</span>
            <span class="ruby-identifier">full_message</span> = <span class="ruby-identifier">error</span>
            <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">error_description</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">full_message</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">error_description</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProviderError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">full_message</span>)
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># If everything went ok, make the network call to get an access token.</span>

    <span class="ruby-identifier">access_token</span>, <span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">_finish</span>(<span class="ruby-identifier">code</span>, <span class="ruby-ivar">@redirect_uri</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">access_token</span>, <span class="ruby-identifier">user_id</span>, <span class="ruby-identifier">url_state</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- finish-source -->
            
          </div>

          

          
        </div><!-- finish-method -->

      
        <div id="start-method" class="method-detail ">
          <a name="method-i-start"></a>

          
          <div class="method-heading">
            <span class="method-name">start</span><span
              class="method-args">(url_state=nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Starts the OAuth 2 authorizaton process, which involves redirecting the
user to the returned “authorization URL” (a URL on the Dropbox website). 
When the user then either approves or denies your app access, Dropbox will
redirect them to the redirect_uri you provided to the constructor, at which
point you should call finish() to complete the process.</p>

<p>This function will also save a CSRF token to the session and
csrf_token_session_key you provided to the constructor.  This CSRF token
will be checked on finish() to prevent request forgery.</p>
<ul><li>
<p>url_state: Any data you would like to keep in the URL through the
authorization process.  This exact value will be returned to you by
finish().</p>
</li></ul>

<p>Returns the URL to redirect the user to.</p>
            

            
            <div class="method-source-code" id="start-source">
<pre>
<span class="ruby-comment"># File build/dropbox-ruby-sdk-1.6.2/lib/dropbox_sdk.rb, line 507</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start</span>(<span class="ruby-identifier">url_state</span>=<span class="ruby-keyword">nil</span>)
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">url_state</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">url_state</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;url_state must be a String&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">csrf_token</span> = <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">base64</span>(<span class="ruby-value">16</span>)
    <span class="ruby-identifier">state</span> = <span class="ruby-identifier">csrf_token</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">url_state</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">state</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;|&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">url_state</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@session</span>[<span class="ruby-ivar">@csrf_token_session_key</span>] = <span class="ruby-identifier">csrf_token</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">_get_authorize_url</span>(<span class="ruby-ivar">@redirect_uri</span>, <span class="ruby-identifier">state</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- start-source -->
            
          </div>

          

          
        </div><!-- start-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

